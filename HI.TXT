print("=== [TESTING] Device Security TRD 2.8.1.4 - Listening Ports on LAN (GID-MTRREQ-521707) [MANDATORY] ===")
print("Note: Ensure only allowed ports (80, 443 for Web UI, 53 for DNS) are open. Services must not listen on 0.0.0.0 unless explicitly required.")

def print_results(self):
    if self.normal_ports or self.abnormal_ports:
        print("\n=== Normal Ports ===")
        print("\n".join(self.normal_ports) if self.normal_ports else "No normal ports found")
        print("\n=== Abnormal Ports ===")
        print("\n".join(self.abnormal_ports) if self.abnormal_ports else "No abnormal ports found")
    else:
        print("No open ports found")

    print("\nNmap Scan was successful")
    print("\n=== Extracted CPEs and Vulnerabilities ===")
    
    cpe_dict = self.parse_cpe_dictionary(r"C:\Users\Offband\Documents\official-cpe-dictionary_v2.3.xml")     

    if not self.cpes:
        print("\n⚠️  No CPEs with specific version information were extracted from the Nmap scan.")
        print("This means the scan did not detect services with identifiable product + version info mapped to official CPEs.")
        print("Without a CPE that includes an exact version, no CVE-based vulnerability analysis can be performed.")
        print("As a result, we cannot confirm or deny the presence of known vulnerabilities for these services.\n")
        return

    for cpe_23 in self.cpes:
        converted_cpe = self.convert_cpe_2_2_to_2_3(cpe_23)
        print(f"\nChecking CPE: {converted_cpe}")

        if not self.is_cpe_qualified(converted_cpe):
            print("\n" + "="*150)
            print(f"⚠️ Service '{converted_cpe}' does not have a specific version. Skipping NVD lookup.")
            print("You may manually verify the version and search for vulnerabilities if needed.")
            print("="*150 + "\n")
            continue

        # Try direct NVD lookup
        result = self.query_nvd_api(converted_cpe, self.api_key)

        if result.get("error") or not result.get("vulnerable"):
            print(f"\nℹ️ No vulnerabilities found or an error occurred while querying: {converted_cpe}")
            print(f"Trying fuzzy match correction...")

            closest_match, score, exact_version_match = self.fuzzy_match_cpe(converted_cpe, cpe_dict)

            if closest_match:
                if exact_version_match:
                    print(f"\n✅ Closest CPE with exact version: {closest_match} (score: {score})")
                    print("Performing NVD lookup...\n")
                    result = self.query_nvd_api(closest_match, self.api_key)
                    print("="*150 + "\n")
                    print(json.dumps(result, indent=2))
                    print("="*150 + "\n")
                else:
                    print(f"\n⚠️ Version does not match exactly. Skipping NVD lookup.")
                    print(f"Closest available CPE (fuzzy matched): {closest_match} (score: {score})")
                    print("You may inspect this CPE manually in the NVD database if needed.\n")
            else:
                print("❌ No good fuzzy match found.")
        else:
            print("="*150 + "\n")
            print(json.dumps(result, indent=2))
            print("="*150 + "\n")
=== Extracted CPEs and Vulnerabilities ===
Found 1347462 usable CPEs (including replacements).

Checking CPE: cpe:2.3:a:matt_johnston:dropbear_ssh_server:2019.78:*:*:*:*:*:*:*

ℹ️ No vulnerabilities found or an error occurred while querying: cpe:2.3:a:matt_johnston:dropbear_ssh_server:2019.78:*:*:*:*:*:*:*
Trying fuzzy match correction...

✅ Closest CPE with exact version: cpe:2.3:a:dropbear_ssh_project:dropbear_ssh:2019.78:*:*:*:*:*:*:* (score: 65.7)
Performing NVD lookup...

======================================================================================================================================================

{
  "cpe": "cpe:2.3:a:dropbear_ssh_project:dropbear_ssh:2019.78:*:*:*:*:*:*:*",
  "product": "dropbear_ssh",
  "version": "2019.78",
  "vulnerable": true,
  "vulnerabilities": [
    {
      "cve_id": "CVE-2023-48795",
      "description": "The SSH transport protocol with certain OpenSSH extensions, found in OpenSSH before 9.6 and other products, allows remote attackers to bypass integrity checks such that some packets are omitted (from the extension negotiation message), and a client and server may consequently end up with a connection for which some security features have been downgraded or disabled, aka a Terrapin attack. This occurs because the SSH Binary Packet Protocol (BPP), implemented by these extensions, mishandles the handshake phase and mishandles use of sequence numbers. For example, there is an effective attack against SSH's use of ChaCha20-Poly1305 (and CBC with Encrypt-then-MAC). The bypass occurs in chacha20-poly1305@openssh.com and (if CBC is used) the -etm@openssh.com MAC algorithms. This also affects Maverick Synergy Java SSH API before 3.1.0-SNAPSHOT, Dropbear through 2022.83, Ssh before 5.1.1 in Erlang/OTP, PuTTY before 0.80, AsyncSSH before 2.14.2, golang.org/x/crypto before 0.17.0, libssh before 0.10.6, libssh2 through 1.11.0, Thorn Tech SFTP Gateway before 3.4.6, Tera Term before 5.1, Paramiko before 3.4.0, jsch before 0.2.15, SFTPGo before 2.5.6, Netgate pfSense Plus through 23.09.1, Netgate pfSense CE through 2.7.2, HPN-SSH through 18.2.0, ProFTPD before 1.3.8b (and before 1.3.9rc2), ORYX CycloneSSH before 2.3.4, NetSarang XShell 7 before Build 0144, CrushFTP before 10.6.0, ConnectBot SSH library before 2.2.22, Apache MINA sshd through 2.11.0, sshj through 0.37.0, TinySSH through 20230101, trilead-ssh2 6401, LANCOM LCOS and LANconfig, FileZilla before 3.66.4, Nova before 11.8, PKIX-SSH before 14.4, SecureCRT before 9.4.3, Transmit5 before 5.10.4, Win32-OpenSSH before 9.5.0.0p1-Beta, WinSCP before 6.2.2, Bitvise SSH Server before 9.32, Bitvise SSH Client before 9.33, KiTTY through 0.76.1.13, the net-ssh gem 7.2.0 for Ruby, the mscdex ssh2 module before 1.15.0 for Node.js, the thrussh library before 0.35.1 for Rust, and the Russh crate before 0.40.2 for Rust.",        
      "cvss_info": {
        "v3.1": {
          "score": 5.9,
          "severity": "MEDIUM"
        },
        "v3.0": {
          "score": "N/A",
          "severity": "N/A"
        },
        "v2.0": {
          "score": "N/A",
          "severity": "N/A"
        }
      },
      "published_date": "2023-12-18T16:15:10.897",
      "source": "http://packetstormsecurity.com/files/176280/Terrapin-SSH-Connection-Weakening.html"
    },
    {
      "cve_id": "CVE-2021-36369",
      "description": "An issue was discovered in Dropbear through 2020.81. Due to a non-RFC-compliant check of the available authentication methods in the client-side SSH code, it is possible for an SSH server to change the login process in its favor. This attack can bypass additional security measures such as FIDO2 tokens or SSH-Askpass. Thus, it allows an attacker to abuse a forwarded agent for logging on to another server unnoticed.",
      "cvss_info": {
        "v3.1": {
          "score": 7.5,
          "severity": "HIGH"
        },
        "v3.0": {
          "score": "N/A",
          "severity": "N/A"
        },
        "v2.0": {
          "score": "N/A",
          "severity": "N/A"
        }
      },
      "published_date": "2022-10-12T21:15:09.493",
      "source": "https://github.com/mkj/dropbear/pull/128"
    },
    {
      "cve_id": "CVE-2020-36254",
      "description": "scp.c in Dropbear before 2020.79 mishandles the filename of . or an empty filename, a related issue to CVE-2018-20685.",
      "cvss_info": {
        "v3.1": {
          "score": 8.1,
          "severity": "HIGH"
        },
        "v3.0": {
          "score": "N/A",
          "severity": "N/A"
        },
        "v2.0": {
          "score": "N/A",
          "severity": "N/A"
        }
      },
      "published_date": "2021-02-25T09:15:13.037",
      "source": "https://github.com/mkj/dropbear/commit/8f8a3dff705fad774a10864a2e3dbcfa9779ceff"
    }
  ]
}
======================================================================================================================================================


Checking CPE: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*

======================================================================================================================================================
⚠️ Service 'cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*' does not have a specific version. Skipping NVD lookup.
You may manually verify the version and search for vulnerabilities if needed.
======================================================================================================================================================


Checking CPE: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*

ℹ️ No vulnerabilities found or an error occurred while querying: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*
Trying fuzzy match correction...

⚠️ Version does not match exactly. Skipping NVD lookup.
Closest available CPE (fuzzy matched): cpe:2.3:a:lighttpd:lighttpd:1.4.6:*:*:*:*:*:*:* (score: 98.2)
You may inspect this CPE manually in the NVD database if needed.


Checking CPE: cpe:2.3:o:linux:linux_kernel:5.4.213%2Byocto:*:*:*:*:*:*:*

ℹ️ No vulnerabilities found or an error occurred while querying: cpe:2.3:o:linux:linux_kernel:5.4.213%2Byocto:*:*:*:*:*:*:*
Trying fuzzy match correction...

Checking CPE: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*

ℹ️ No vulnerabilities found or an error occurred while querying: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*
Trying fuzzy match correction...

⚠️ Version does not match exactly. Skipping NVD lookup.
Closest available CPE (fuzzy matched): cpe:2.3:a:lighttpd:lighttpd:1.4.6:*:*:*:*:*:*:* (score: 98.2)
You may inspect this CPE manually in the NVD database if needed.


Checking CPE: cpe:2.3:o:linux:linux_kernel:5.4.213%2Byocto:*:*:*:*:*:*:*

ℹ️ No vulnerabilities found or an error occurred while querying: cpe:2.3:o:linux:linux_kernel:5.4.213%2Byocto:*:*:*:*:*:*:*

Checking CPE: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*

ℹ️ No vulnerabilities found or an error occurred while querying: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*
Trying fuzzy match correction...

⚠️ Version does not match exactly. Skipping NVD lookup.
Closest available CPE (fuzzy matched): cpe:2.3:a:lighttpd:lighttpd:1.4.6:*:*:*:*:*:*:* (score: 98.2)
You may inspect this CPE manually in the NVD database if needed.


Checking CPE: cpe:2.3:o:linux:linux_kernel:5.4.213%2Byocto:*:*:*:*:*:*:*

Checking CPE: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*

ℹ️ No vulnerabilities found or an error occurred while querying: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*
Trying fuzzy match correction...

⚠️ Version does not match exactly. Skipping NVD lookup.
Closest available CPE (fuzzy matched): cpe:2.3:a:lighttpd:lighttpd:1.4.6:*:*:*:*:*:*:* (score: 98.2)
You may inspect this CPE manually in the NVD database if needed.


Checking CPE: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*

ℹ️ No vulnerabilities found or an error occurred while querying: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*
Trying fuzzy match correction...

⚠️ Version does not match exactly. Skipping NVD lookup.

Checking CPE: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*

ℹ️ No vulnerabilities found or an error occurred while querying: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*
Trying fuzzy match correction...

Checking CPE: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*



Checking CPE: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*

ℹ️ No vulnerabilities found or an error occurred while querying: cpe:2.3:a:lighttpd:lighttpd:1.4.69:*:*:*:*:*:*:*
Trying fuzzy match correction...

⚠️ Version does not match exactly. Skipping NVD lookup.
Closest available CPE (fuzzy matched): cpe:2.3:a:lighttpd:lighttpd:1.4.6:*:*:*:*:*:*:* (score: 98.2)
You may inspect this CPE manually in the NVD database if needed.


Checking CPE: cpe:2.3:o:linux:linux_kernel:5.4.213%2Byocto:*:*:*:*:*:*:*

ℹ️ No vulnerabilities found or an error occurred while querying: cpe:2.3:o:linux:linux_kernel:5.4.213%2Byocto:*:*:*:*:*:*:*
Trying fuzzy match correction...

⚠️ Version does not match exactly. Skipping NVD lookup.
Closest available CPE (fuzzy matched): cpe:2.3:o:linux:linux_kernel:5.4.132:*:*:*:*:*:*:* (score: 92.8)
You may inspect this CPE manually in the NVD database if needed.

Scan results saved to final.txt
